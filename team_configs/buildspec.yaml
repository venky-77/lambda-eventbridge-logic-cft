version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.9
    commands:
      - echo "ðŸ”§ Installing dependencies..."
      - pip install Jinja2 PyYAML

  build:
    commands:
      - echo "ðŸ“¦ Rendering CloudFormation templates from changed parameter files..."
      - python render.py
      - echo "ðŸ“‚ Contents of output/:"
      - ls -l output/ || echo "No templates generated."

  post_build:
    commands:
      - echo "ðŸš€ Deploying rendered templates..."
      - |
        if [ -d output ] && [ "$(ls -A output)" ]; then
          for file in output/*.yaml; do
            stack_name=$(basename "$file" .yaml)
            echo "Deploying stack: $stack_name"
            aws cloudformation deploy \
              --template-file "$file" \
              --stack-name "$stack_name" \
              --capabilities CAPABILITY_NAMED_IAM \
              --no-fail-on-empty-changeset
          done
        else
          echo "âœ… No templates to deploy. Skipping."
        fi

artifacts:
  files:
    - output/*.yaml